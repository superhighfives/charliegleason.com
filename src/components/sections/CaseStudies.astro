---
import Tile from '../islands/Tile';
import Title from '../ui/Title.astro';
import Link from '../ui/Link.astro';
import HR from '../ui/HR.astro';
import type { CaseStudyCard } from '../../data/caseStudies';

interface Props {
  caseStudies: { title: string; data: CaseStudyCard[] };
  isAuthenticated?: boolean;
}

const { caseStudies, isAuthenticated = false } = Astro.props;

// Filter out protected case studies if not authenticated
const visibleCaseStudies = caseStudies.data.filter(
  (cs) => !cs.protected || isAuthenticated
);

// Helper to parse hero text with highlight
function parseHero(hero: string, highlightText: string, highlightClasses: string) {
  const [start, end] = hero.split('{highlightText}');
  return { start, end, highlightText, highlightClasses };
}
---

<div class="space-y-12">
  <HR />
  <div id="case-studies" class="grid gap-6 lg:gap-12 scroll-m-16">
  <div>
    <Title>{caseStudies.title}</Title>
  </div>
  
  <div class="flex flex-col sm:flex-row lg:flex-col gap-16">
    {visibleCaseStudies.map((caseStudy) => {
      const parsed = parseHero(caseStudy.hero, caseStudy.highlightText, caseStudy.highlightClasses);
      return (
        <div class="flex flex-col lg:flex-row gap-2 lg:gap-16">
          <div class="lg:basis-1/3 lg:flex-shrink-0">
            <Tile
              client:visible
              id={caseStudy.id}
              href={caseStudy.href}
              title={caseStudy.title}
              color={caseStudy.color as any}
              format="webp"
              type="case-studies"
            />
          </div>
          <div class="dark:border-neutral-800 flex flex-col items-start justify-center gap-6 lg:basis-2/3">
            <div class="flex flex-col gap-3">
              <h1 class="text-3xl lg:text-4xl font-display text-balance">
                {parsed.start}
                <span class={parsed.highlightClasses}>{parsed.highlightText}</span>
                {parsed.end}
              </h1>
              <p class="max-w-3xl leading-relaxed text-neutral-700 dark:text-neutral-300">
                {caseStudy.description}
              </p>
            </div>
            <Link icon="forward" href={caseStudy.href} background={false} padding="large" class="inline-block not-prose px-4">
              View Case Study
            </Link>
          </div>
        </div>
      );
    })}
  </div>
  </div>
</div>
