---
const preference = Astro.locals.themePreference || "auto";
---

<theme-toggle data-preference={preference}>
	<button type="button" aria-label="Toggle theme" class="theme-button">
		<span class="label">Theme:</span>
		<span class="current">{preference}</span>
	</button>
</theme-toggle>

<script>
	class ThemeToggle extends HTMLElement {
		private button: HTMLButtonElement | null;
		private preferences: Array<"light" | "dark" | "auto"> = [
			"light",
			"dark",
			"auto",
		];

		constructor() {
			super();
			this.button = this.querySelector("button");
		}

		connectedCallback() {
			this.button?.addEventListener("click", () => this.cycle());
		}

		async cycle() {
			const current = this.dataset.preference as "light" | "dark" | "auto";
			const index = this.preferences.indexOf(current);
			const next = this.preferences[(index + 1) % 3];

			// Update UI
			this.dataset.preference = next;
			const label = this.querySelector(".current");
			if (label) label.textContent = next;

			// Persist to cookie via API
			await fetch("/api/theme", {
				method: "POST",
				body: JSON.stringify({ theme: next }),
				headers: { "Content-Type": "application/json" },
			});

			// Apply theme immediately
			const html = document.documentElement;
			html.classList.remove("light", "dark");
			html.dataset.themePreference = next;

			if (next === "auto") {
				const prefersDark = window.matchMedia(
					"(prefers-color-scheme: dark)"
				).matches;
				html.classList.add(prefersDark ? "dark" : "light");
			} else {
				html.classList.add(next);
			}
		}
	}
	customElements.define("theme-toggle", ThemeToggle);
</script>

<style>
	.theme-button {
		font-size: 0.625rem;
		color: var(--color-text-muted);
		background: none;
		border: none;
		cursor: pointer;
		padding: 0;
		font-family: inherit;
	}
	.theme-button:hover {
		color: var(--color-link);
	}
</style>
