---
import { Effect } from "effect";
import Layout from "../layouts/Layout.astro";
import { login, safeRedirect } from "../lib/auth";
import Avatar from "../components/ui/Avatar.astro";
import Link from "../components/ui/Link.astro";
import HR from "../components/ui/HR.astro";

// If user is already logged in, redirect home
const user = Astro.locals.user;
if (user) {
  return Astro.redirect("/");
}

// Get redirect target from query params
const url = new URL(Astro.request.url);
const redirectTo = safeRedirect(url.searchParams.get("redirectTo"));
const errorParam = url.searchParams.get("error");

let error = "";

// Handle POST request (login attempt)
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const password = formData.get("password") as string;
  const formRedirectTo = safeRedirect(formData.get("redirectTo") as string);

  const env = Astro.locals.runtime?.env;

  if (!env) {
    error = "Server configuration error";
  } else {
    const result = await Effect.runPromise(
      login(env, password, formRedirectTo).pipe(
        Effect.catchAll((kvError) =>
          Effect.gen(function* () {
            yield* Effect.logError(`Login KV error: ${kvError._tag}`);
            return { _tag: "LoginFailure" as const, error: "Server error" };
          })
        )
      )
    );

    if (result._tag === "LoginSuccess") {
      return new Response(null, {
        status: 302,
        headers: {
          Location: result.redirectTo,
          ...result.headers,
        },
      });
    } else {
      error = result.error || "Invalid password";
    }
  }
}

// Show error from query param (e.g., from failed auth)
if (errorParam === "unauthorized") {
  error = "Incorrect password. Please try again.";
}
---

<Layout title="Login">
  <main class="grid place-items-center h-full">
    <div class="flex items-start gap-4">
      <div class="flex">
        <Avatar symbol="&#128584;" photo="01" />
      </div>
      <div class="max-w-xs space-y-0">
        <hgroup class="inline-flex whitespace-nowrap gap-1 font-display uppercase tracking-wider text-xs">
          <h1>C#@rl!e G/3as0n</h1>
          <h2 class="bg-yellow-800 dark:bg-yellow-300 bg-clip-text text-transparent bg-gradient-to-r from-yellow-600 dark:from-yellow-500 to-transparent">needs you to log in</h2>
        </hgroup>
        <div class="space-y-4">
          <h1 class="font-mono text-lg">This is a protected area.</h1>
          <div class="space-y-4 text-sm text-neutral-600 dark:text-neutral-400">
            <p>
              To abide by Intellectual Property policies, this content is
              <span class="font-semibold">password protected</span>.
            </p>
            <p>
              <Link type="text" href="mailto:hi@charliegleason.com">Contact me</Link> to get access.
            </p>
          </div>
          <HR />
          <form method="POST" class="h-full space-y-2">
            <input type="hidden" name="redirectTo" value={redirectTo} />
            <label for="password" class="sr-only">Password</label>
            <div class="mt-1 flex rounded-md shadow-sm">
              <div class="relative flex flex-grow items-stretch focus-within:z-10">
                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="h-4 w-4 transition-color text-neutral-500">
                    <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 0 0-4.5 4.5V9H5a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2h-.5V5.5A4.5 4.5 0 0 0 10 1Zm3 8V5.5a3 3 0 1 0-6 0V9h6Z" clip-rule="evenodd"></path>
                  </svg>
                </div>
                <input
                  type="password"
                  name="password"
                  id="password"
                  autocomplete="current-password"
                  class="block w-full rounded-none rounded-l-md bg-neutral-100 dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 pl-10 py-2 focus:border-yellow-500 focus:ring-yellow-500 focus:outline-none text-sm"
                  placeholder="Enter password..."
                  required
                />
              </div>
              <button
                type="submit"
                class="relative -ml-px inline-flex items-center rounded-r-md border border-yellow-500 dark:border-yellow-700 bg-yellow-50 dark:bg-neutral-900 px-4 py-2 text-sm font-medium text-yellow-700 dark:text-yellow-400 hover:bg-yellow-100 dark:hover:bg-yellow-800 focus:border-yellow-500 focus:outline-none focus:ring-1 focus:ring-yellow-500"
              >
                <span class="sr-only">Submit</span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="h-4 w-4">
                  <path fill-rule="evenodd" d="M3 10a.75.75 0 0 1 .75-.75h10.638L10.23 5.29a.75.75 0 1 1 1.04-1.08l5.5 5.25a.75.75 0 0 1 0 1.08l-5.5 5.25a.75.75 0 1 1-1.04-1.08l4.158-3.96H3.75A.75.75 0 0 1 3 10Z" clip-rule="evenodd"></path>
                </svg>
              </button>
            </div>
            {error ? (
              <p class="text-xs font-mono text-yellow-600 dark:text-yellow-400">{error}</p>
            ) : (
              <div class="text-xs font-mono text-transparent">...</div>
            )}
          </form>
        </div>
      </div>
    </div>
  </main>
</Layout>
