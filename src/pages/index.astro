---
import { Effect } from "effect";
import Layout from "../layouts/Layout.astro";
import Container from "../components/ui/Container.astro";
import Header from "../components/Header.astro";
import Sections from "../components/ui/Sections.astro";
import Footer from "../components/Footer.astro";

import Overview from "../components/sections/Overview.astro";
import CaseStudies from "../components/sections/CaseStudies.astro";
import Work from "../components/sections/Work.astro";
import Selected from "../components/sections/Selected.astro";
import Quotes from "../components/sections/Quotes.astro";
import Links from "../components/sections/Links.astro";

import { caseStudies, projects, articles, features } from "../data";
import { sampleSize, random } from "lodash-es";
import { fetchPosts, type Posts } from "../lib/posts";

// Emoji list for random favicon selection
const emojiList = [
  "ðŸŒŠ",
  "ðŸŽ¨",
  "ðŸŽµ",
  "ðŸ’»",
  "ðŸŒˆ",
  "ðŸŽ­",
  "ðŸŽª",
  "ðŸŽ¯",
  "ðŸŒŸ",
  "ðŸ”®",
  "ðŸŽ¸",
  "ðŸŽ¹",
  "ðŸŽº",
  "ðŸŽ»",
  "ðŸª—",
  "ðŸ¥",
  "ðŸª˜",
  "ðŸŽ¤",
  "ðŸŽ§",
  "ðŸŽ¼",
  "ðŸŽ¬",
  "ðŸ“·",
  "ðŸ–¼ï¸",
  "ðŸŽ¨",
  "ðŸ–Œï¸",
  "âœï¸",
  "ðŸ“",
  "ðŸ’¡",
  "ðŸ”¥",
  "âš¡",
  "ðŸŒ™",
  "â˜€ï¸",
  "ðŸŒ",
  "ðŸŒŽ",
  "ðŸŒ",
];

// Generate random avatar and emoji for this request
const symbol = sampleSize(emojiList, Math.ceil(Math.random() * 3)).join("");
const photo = String(random(1, 10)).padStart(2, "0");

// Get user from locals (set by middleware)
const user = Astro.locals.user;
const isAuthenticated = user?.id === "guest";

// Fetch blog posts using Effect
const codeEndpoint =
  import.meta.env.CODE_ENDPOINT || "https://code.charliegleason.com";

interface PostsState {
  posts?: Posts;
  error?: string;
}

const postsState: PostsState = await Effect.runPromise(
  fetchPosts(codeEndpoint, 6).pipe(
    Effect.map((posts) => ({ posts })),
    Effect.catchAll((error) =>
      Effect.gen(function* () {
        yield* Effect.logError(`Initial posts fetch failed: ${error._tag}`);
        return { error: "Unable to load recent posts" };
      })
    )
  )
);
---

<Layout symbol={symbol}>
  <Container variant="wide">
    <Header symbol={symbol} photo={photo} />
    <Sections>
      <Overview
        posts={postsState.posts}
        postsError={postsState.error}
        endpoint={codeEndpoint}
      />
      <CaseStudies
        caseStudies={caseStudies}
        isAuthenticated={isAuthenticated}
      />
      <Work />
      <Selected sections={[projects, articles, features]} />
      <Quotes />
      <Links />
    </Sections>
    <Footer user={user} />
  </Container>
</Layout>
